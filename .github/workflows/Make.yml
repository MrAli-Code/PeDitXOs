name: Build PeDitXOs ISO

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt-get install -y debootstrap xorriso squashfs-tools grub-common

    - name: Create minimal Linux filesystem
      run: |
        sudo debootstrap --variant=minbase --include=nano,parted,gzip,curl,wget,fdisk,whiptail,dialog,systemd,grub-common stable ./PeDitXOs-rootfs http://deb.debian.org/debian

    - name: Install additional software
      run: |
        sudo chroot ./PeDitXOs-rootfs apt-get update
        sudo chroot ./PeDitXOs-rootfs apt-get install -y nano parted gzip curl wget fdisk whiptail dialog systemd grub-common

    - name: Download and set boot logo
      run: |
        sudo mkdir -p ./PeDitXOs-rootfs/boot/grub
        sudo wget https://raw.githubusercontent.com/peditx/luci-theme-peditx/refs/heads/main/luasrc/brand.png -O ./PeDitXOs-rootfs/boot/grub/brand.png
        echo 'GRUB_BACKGROUND="/boot/grub/brand.png"' | sudo tee -a ./PeDitXOs-rootfs/etc/default/grub
        sudo chroot ./PeDitXOs-rootfs update-grub

    - name: Download and configure installer script
      run: |
        sudo wget https://raw.githubusercontent.com/peditx/PeDitXOs/refs/heads/main/scripts/PeDitXrt_installer.sh -O ./PeDitXOs-rootfs/usr/local/bin/PeDitXrt_installer.sh
        sudo chmod +x ./PeDitXOs-rootfs/usr/local/bin/PeDitXrt_installer.sh
        echo '#!/bin/sh' | sudo tee ./PeDitXOs-rootfs/etc/rc.local
        echo '/usr/local/bin/PeDitXrt_installer.sh' | sudo tee -a ./PeDitXOs-rootfs/etc/rc.local
        echo 'exit 0' | sudo tee -a ./PeDitXOs-rootfs/etc/rc.local
        sudo chmod +x ./PeDitXOs-rootfs/etc/rc.local

    - name: Disable terminal access
      run: |
        sudo rm -f ./PeDitXOs-rootfs/etc/systemd/system/getty.target.wants/getty@tty1.service
        sudo rm -f ./PeDitXOs-rootfs/etc/systemd/system/getty.target.wants/getty@tty2.service
        sudo rm -f ./PeDitXOs-rootfs/etc/systemd/system/getty.target.wants/getty@tty3.service

    - name: Create ISO image
      run: |
        sudo mkdir -p ./PeDitXOs-rootfs/boot/grub
        echo 'set timeout=0' | sudo tee ./PeDitXOs-rootfs/boot/grub/grub.cfg
        echo 'menuentry "PeDitXOs" {' | sudo tee -a ./PeDitXOs-rootfs/boot/grub/grub.cfg
        echo '  linux /vmlinuz root=/dev/sda1 quiet splash' | sudo tee -a ./PeDitXOs-rootfs/boot/grub/grub.cfg
        echo '  initrd /initrd.img' | sudo tee -a ./PeDitXOs-rootfs/boot/grub/grub.cfg
        echo '}' | sudo tee -a ./PeDitXOs-rootfs/boot/grub/grub.cfg

        sudo xorriso -as mkisofs -o PeDitXOs.iso -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin -c isolinux/boot.cat -b isolinux/isolinux.bin -no-emul-boot -boot-load-size 4 -boot-info-table ./PeDitXOs-rootfs

    - name: Upload ISO as artifact
      uses: actions/upload-artifact@v3
      with:
        name: PeDitXOs.iso
        path: PeDitXOs.iso
