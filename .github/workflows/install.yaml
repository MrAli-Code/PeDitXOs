name: Build and Modify PeDitXOs

on:
  push:
    branches:
      - main

jobs:
  build-and-modify-peditxos:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Git repository
        uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl nano parted libisoburn1 libisoburn-dev

      - name: Compile PeDitXOs
        run: |
          # Add commands to compile PeDitXOs here

      - name: Modify Boot Logo
        run: |
          wget https://peditx.ir/wp-content/uploads/2023/05/lastg-logo.png -O boot-logo.png
          sudo mv boot-logo.png /boot/grub/splash.png

      - name: Create ISO File
        run: |
          wget http://mirror.aarnet.edu.au/pub/finnix/120/finnix-120.iso -O original.iso
          mkdir -p iso
          mv original.iso iso/PeDitXOs-$(date +'%Y%m%d').iso

      - name: Upload ISO File
        uses: actions/upload-artifact@main
        if: steps.organize.outputs.status == 'success' && !cancelled()
        with:
          name: PeDitXOs ISO
          path: iso/PeDitXOs-$(date +'%Y%m%d').iso
          if-no-files-found: warn

      - name: Upload firmware to release
        uses: softprops/action-gh-release@v1
        if: steps.tag.outputs.status == 'success' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: ${{ env.FIRMWARE }}/*

      - name: Delete workflow runs
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 3

      - name: Remove old Releases
        uses: dev-drprasad/delete-older-releases@v0.1.0
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
